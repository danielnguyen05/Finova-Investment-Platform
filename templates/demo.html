<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Data Search</title>

    <!-- Include Styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='normalize.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body class="about-page">
    
    <!-- Particles.js Effect -->
    <div id="particles-js"></div>

    <!-- Navigation Bar -->
    <nav>
        <ul class="barra-navegacion">
            <div class="contenedor-nav main-container">
                <li class="header-logo izquierda"><a href="{{ url_for('index') }}">FINOVA</a></li>
                <li class="nav-boton"><a href="{{ url_for('about') }}">About</a></li>
                <li class="nav-boton"><a href="{{ url_for('demo') }}">Demo</a></li>
                <li class="nav-boton"><a href="{{ url_for('contact') }}">Contact</a></li>
            </div>
        </ul>
    </nav>

    <!-- Main Content -->
    <div class="main-container contenedor-header">
        <div class="seccion-izquierda">
            <h1 class="animate__animated animate__backInLeft">Financial Data Search</h1>
            <p class="animate__animated animate__backInLeft contenedor-parrafo">
                Search for any company and view their dividend trends, GDP, and other key financial data.
            </p>
        </div>
    </div>

    <!-- Search Bar -->
    <div class="main-container contenedor-seccion">
        <h2>Find a Company</h2>
        <div class="search-container">
            <input type="text" id="companySearch" placeholder="Search for a company..." autocomplete="off">
            <div id="autocompleteResults" class="autocomplete-list"></div>
        </div>
        <!-- ✅ Correct button ID & ensure it's clickable -->
        <button id="fetchDataBtn" class="boton-play animate__animated animate__pulse">Get Data</button>
    </div>

    <hr>

    <!-- Graphs Section -->
    <div class="main-container contenedor-seccion">
        <h2>Company Dividend Trends</h2>
        <img id="dividendsGraph" src="/static/company_dividends_plot.png" alt="Company Dividend Trends Graph">

        <h2>Real GDP Over Time</h2>
        <img id="gdpGraph" src="/static/real_gdp_plot.png" alt="Real GDP Graph">

        <h2>Real GDP Per Capita Over Time</h2>
        <img id="gdpPerCapitaGraph" src="/static/real_gdp_per_capita_plot.png" alt="Real GDP Per Capita Graph">
    </div>

    <!-- ✅ Move JavaScript to end of <body> -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            let companies = [];
            const searchInput = document.getElementById("companySearch");
            const resultsContainer = document.getElementById("autocompleteResults");
            const fetchButton = document.getElementById("fetchDataBtn");

            if (!fetchButton) {
                console.error("❌ Button not found!");
                return;
            }
            console.log("✅ Button found:", fetchButton);

            // ✅ Load JSON file
            async function loadCompanies() {
                try {
                    const response = await fetch("/static/companies.json");
                    companies = await response.json();
                    console.log("✅ Companies Loaded:", companies.length, "companies");
                } catch (error) {
                    console.error("❌ Failed to load companies.json", error);
                }
            }

            function updateAutocomplete() {
                if (companies.length === 0) {
                    console.error("❌ Companies data not loaded yet!");
                    return;
                }

                const searchValue = searchInput.value.toLowerCase();
                resultsContainer.innerHTML = "";

                if (!searchValue) {
                    resultsContainer.style.display = "none";
                    return;
                }

                const filtered = companies.filter(company =>
                    company.name && company.symbol &&  
                    (company.name.toLowerCase().includes(searchValue) || 
                    company.symbol.toLowerCase().includes(searchValue))
                );

                if (filtered.length === 0) {
                    resultsContainer.style.display = "none";
                    return;
                }

                filtered.slice(0, 10).forEach(company => {
                    const div = document.createElement("div");
                    div.classList.add("autocomplete-item");
                    div.textContent = `${company.name} (${company.symbol})`;
                    div.onclick = () => selectCompany(company.symbol);
                    resultsContainer.appendChild(div);
                });

                resultsContainer.style.display = "block";
            }

            function selectCompany(symbol) {
                searchInput.value = symbol;
                resultsContainer.style.display = "none";
                console.log("✅ Selected:", symbol);
            }

            async function fetchGraphs() {
                const company = searchInput.value.trim();
                if (!company) {
                    console.error("❌ No company selected!");
                    return;
                }

                console.log("📡 Sending request to /api/graphs for:", company);

                fetch("/api/graphs", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ company })
                })
                .then(response => response.json())
                .then(data => {
                    console.log("✅ API Response:", data);

                    if (data.error) {
                        console.error("❌ Error from API:", data.error);
                        return;
                    }

                    document.getElementById("dividendsGraph").src = data.dividends_url + "?" + new Date().getTime();
                    document.getElementById("gdpGraph").src = data.gdp_url + "?" + new Date().getTime();
                    document.getElementById("gdpPerCapitaGraph").src = data.gdp_per_capita_url + "?" + new Date().getTime();
                })
                .catch(error => {
                    console.error("❌ Error calling /api/graphs:", error);
                });
            }

            searchInput.addEventListener("input", updateAutocomplete);
            searchInput.addEventListener("keydown", (event) => {
                if (event.key === "Enter") {
                    event.preventDefault();
                }
            });

            document.addEventListener("click", (event) => {
                if (!searchInput.contains(event.target) && !resultsContainer.contains(event.target)) {
                    resultsContainer.style.display = "none";
                }
            });

            // ✅ Attach event listener to button
            fetchButton.addEventListener("click", fetchGraphs);
            loadCompanies();
        });
    </script>

    <!-- Background Effects -->
    <script src="{{ url_for('static', filename='particles.js') }}"></script>
    <script src="{{ url_for('static', filename='app.js') }}"></script>

</body>
</html>
